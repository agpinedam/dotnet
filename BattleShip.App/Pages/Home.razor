@page "/"
@using BattleShip.App.Services
@using BattleShip.Models
@using BattleShip.App.Components
@inject GameClient GameClient

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

<div class="mb-3 control-panel">
    <div class="d-flex align-items-center flex-wrap gap-2">
        <label class="form-label fw-bold">Difficulty:</label>
        <select class="form-select w-auto" @bind="_selectedDifficulty">
            <option value="@DifficultyLevel.Easy">Easy</option>
            <option value="@DifficultyLevel.Medium">Medium</option>
            <option value="@DifficultyLevel.Hard">Hard</option>
        </select>

        <label class="form-label fw-bold ms-2">Grid Size:</label>
        <select class="form-select w-auto" @bind="_selectGridSize">
            <option value="10">10x10</option>
            <option value="12">12x12</option>
            <option value="15">15x15</option>
            <option value="20">20x20</option>
        </select>

        <div class="ms-3 border-start ps-3">
            <button class="btn btn-primary" @onclick="() => StartGame(false)">New Game (REST)</button>
            <button class="btn btn-secondary ms-1" @onclick="() => StartGame(true)">New Game (gRPC)</button>
        </div>

        @if (IsGameActive)
        {
            <button class="btn btn-warning ms-2" @onclick="UndoAsync">Undo Last Move</button>
        }
        
        <span class="ms-3 fw-bold text-info">@GameClient.Message</span>
    </div>
</div>

@if (GameClient.CurrentGame != null)
{
    <div class="container-fluid">
        @if (IsSetupPhase)
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-info-circle-fill me-2"></i>
                    @_setupMessage
                </span>
                <button class="btn btn-success btn-sm" @onclick="ConfirmPlacementAsync">
                    Confirm Placement & Start
                </button>
            </div>
        }

        <div class="row g-4">
            <div class="col-md-6">
                <h3 class="text-primary">Your Grid</h3>
                
                <GridBoard 
                    PlayerGrid="@GameClient.CurrentGame.PlayerGrid"
                    Ships="@(IsSetupPhase ? _setupShips : GameClient.CurrentGame.Ships)"
                    IsDraggable="@IsSetupPhase"
                    IsInteractive="@false"
                    OnDrop="@(args => OnDrop(args.Row, args.Col))"
                    OnDragStart="@OnDragStart"
                    OnRotate="@RotateShip"
                />
            </div>

            <div class="col-md-6">
                <h3 class="text-danger">Opponent Grid</h3>
                <GridBoard 
                    OpponentGrid="@GameClient.CurrentGame.OpponentGrid"
                    IsInteractive="@(!GameClient.CurrentGame.IsGameOver && !IsSetupPhase)"
                    OnCellClick="@(args => AttackAsync(args.Row, args.Col))"
                />
            </div>
        </div>

        @if (GameClient.CurrentGame.History.Any())
        {
            <div class="row mt-5">
                <div class="col-12">
                    <h3>Battle Log</h3>
                    <div class="history-container shadow-sm">
                        <table class="table table-hover table-bordered mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Turn</th>
                                    <th>Your Move</th>
                                    <th>Result</th>
                                    <th>Enemy Move</th>
                                    <th>Enemy Result</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var move in ((IEnumerable<MoveHistory>)GameClient.CurrentGame.History).Reverse())
                            {
                                <tr @onclick="() => UndoToTurnAsync(move.Turn - 1)" 
                                    class="cursor-pointer" 
                                    title="Click to time travel to this turn">
                                    <td>@move.Turn</td>
                                    <td>@move.PlayerMove</td>
                                    <td>@GetResultBadge(move.PlayerResult)</td>
                                    <td>@move.AiMove</td>
                                    <td>@GetResultBadge(move.AiResult)</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    /* Utility Classes */
    .cursor-grab { cursor: grab; }
    .cursor-grab:active { cursor: grabbing; }
    .cursor-crosshair { cursor: crosshair; }
    .cursor-pointer { cursor: pointer; }
    
    .hover-effect:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }

    .history-container {
        max-height: 300px; 
        overflow-y: auto;
    }
</style>

@code {
    // -- STATE --
    private DifficultyLevel _selectedDifficulty = DifficultyLevel.Medium;
    private int _selectGridSize = 10;
    
    // Setup Phase State
    private List<ShipInfo> _setupShips = new();
    private ShipInfo? _draggedShip;
    private string? _setupMessage;

    // -- COMPUTED PROPERTIES --
    private bool IsGameActive => GameClient.CurrentGame != null && !GameClient.CurrentGame.IsGameOver;
    private bool IsSetupPhase => GameClient.CurrentGame?.State == GameState.Setup;

    // -- GAME LIFECYCLE METHODS --

    private async Task StartGame(bool useGrpc)
    {
        await GameClient.StartGameAsync(useGrpc, _selectedDifficulty, _selectGridSize );
        
        if (IsSetupPhase)
        {
            _setupShips = GameClient.CurrentGame!.Ships.Select(s => new ShipInfo 
            { 
                Letter = s.Letter, 
                Size = s.Size, 
                Row = s.Row, 
                Col = s.Col, 
                IsHorizontal = s.IsHorizontal 
            }).ToList();
            
            _setupMessage = "Drag and drop ships to reposition. Click a ship to rotate it.";
        }
    }

    private async Task ConfirmPlacementAsync()
    {
        if (GameClient.CurrentGame == null) return;
        
        await GameClient.PlaceShipsAsync(_setupShips);
        
        if (GameClient.CurrentGame.State == GameState.Playing)
        {
            _setupMessage = null;
        }
        else
        {
            _setupMessage = GameClient.Message; 
        }
    }

    private async Task AttackAsync(int row, int col)
    {
        if (GameClient.CurrentGame?.IsGameOver == true) return;
        if (IsSetupPhase) return;
        if (GameClient.CurrentGame?.OpponentGrid[row][col] != null) return;

        await GameClient.AttackAsync(row, col);
    }

    private async Task UndoAsync()
    {
        await GameClient.UndoAsync();
    }
    
    private async Task UndoToTurnAsync(int turn)
    {
        await GameClient.UndoToTurnAsync(turn);
    }

    // -- DRAG AND DROP & SHIP MANIPULATION --

    private void OnDragStart(ShipInfo ship)
    {
        if (!IsSetupPhase) return;
        _draggedShip = ship;
    }

    private void OnDrop(int row, int col)
    {
        if (!IsSetupPhase) return;
        if (_draggedShip == null) return;

        if (IsValidPlacement(_draggedShip, row, col, _draggedShip.IsHorizontal))
        {
            _draggedShip.Row = row;
            _draggedShip.Col = col;
        }
        
        _draggedShip = null;
    }

    private void RotateShip(ShipInfo ship)
    {
        if (!IsSetupPhase) return;
        
        if (IsValidPlacement(ship, ship.Row, ship.Col, !ship.IsHorizontal))
        {
            ship.IsHorizontal = !ship.IsHorizontal;
        }
    }

    private bool IsValidPlacement(ShipInfo shipToPlace, int row, int col, bool isHorizontal)
    {
        var gridSize = GameClient.CurrentGame?.PlayerGrid?.Length ?? _selectGridSize;
        
        // 1. Check Boundaries
        if (row < 0 || col < 0) return false;
        if (isHorizontal)
        {
            if (col + shipToPlace.Size > gridSize) return false;
            if (row >= gridSize) return false;
        }
        else
        {
            if (row + shipToPlace.Size > gridSize) return false;
            if (col >= gridSize) return false;
        }

        // 2. Check Overlaps
        foreach (var otherShip in _setupShips)
        {
            if (otherShip == shipToPlace) continue; 

            // Check intersection
            for (int i = 0; i < shipToPlace.Size; i++)
            {
                int r1 = isHorizontal ? row : row + i;
                int c1 = isHorizontal ? col + i : col;

                for (int j = 0; j < otherShip.Size; j++)
                {
                    int r2 = otherShip.IsHorizontal ? otherShip.Row : otherShip.Row + j;
                    int c2 = otherShip.IsHorizontal ? otherShip.Col + j : otherShip.Col;

                    if (r1 == r2 && c1 == c2) return false;
                }
            }
        }

        return true;
    }

    private RenderFragment GetResultBadge(string result)
    {
        var color = result.Contains("Hit") ? "text-danger fw-bold" : "text-muted";
        return @<span class="@color">@result</span>;
    }
}
