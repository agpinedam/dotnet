@page "/"
@using BattleShip.App.Services
@using BattleShip.Models
@inject GameClient GameClient

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

<div class="mb-3">
    <label class="form-label me-2">Difficulty:</label>
    <select class="form-select d-inline-block w-auto me-3" @bind="_selectedDifficulty">
        <option value="@DifficultyLevel.Easy">Easy</option>
        <option value="@DifficultyLevel.Medium">Medium</option>
        <option value="@DifficultyLevel.Hard">Hard</option>
    </select>
    <label class="form-label me-2">Grid Size </label>
    <select class="form-select d-inline-block w-auto me-3" @bind="_selectGridSize">
        <option value="10">10x10</option>
        <option value="12">12x12</option>
        <option value="15">15x15</option>
        <option value="20">20x20</option>
    </select>

    <button class="btn btn-primary" @onclick="() => StartGame(false)">Start New Game (REST)</button>
    <button class="btn btn-secondary ms-2" @onclick="() => StartGame(true)">Start New Game (gRPC)</button>
    @if (GameClient.CurrentGame != null && !GameClient.CurrentGame.IsGameOver)
    {
        <button class="btn btn-warning ms-2" @onclick="Undo">Undo Last Move</button>
    }
    <span class="ms-3 fw-bold">@GameClient.Message</span>
</div>

@if (GameClient.CurrentGame != null)
{
    <div class="container">
        <div class="row">
            <!-- Player Grid -->
            <div class="col-md-6">
                <h3>Your Grid</h3>
                <div class="battleship-grid" style="position: relative;">
                    <!-- Render Ships -->
                    @foreach (var ship in GameClient.CurrentGame.Ships)
                    {
                        var shipImage = ship.Size switch
                        {
                            4 => "ship4.png",
                            3 => "ship3.png", 
                            2 => "ship2.png",
                            _ => "ship1.png"
                        };

                        const int cellSize = 35; 
                        
                        var top = ship.Row * cellSize; 
                        var left = ship.Col * cellSize;
                        var height = ship.Size * cellSize; 
                        var rotation = ship.IsHorizontal ? "rotate(-90deg)" : "none";

                        <img src="/images/@shipImage" style="position: absolute; 
                                    top: @(top)px; 
                                    left: @(left)px; 
                                    width: @(cellSize)px; 
                                    height: @(height)px; 
                                    z-index: 1;
                                    pointer-events: none;
                                    transform-origin: 17.5px 17.5px;
                                    transform: @rotation;" alt=""/>
                    }

                    @for (int r = 0; r < GameClient.CurrentGame.PlayerGrid.Length; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < GameClient.CurrentGame.PlayerGrid[r].Length; c++)
                            {
                                var cell = GameClient.CurrentGame.PlayerGrid[r][c];
                                <div class="grid-cell" style="z-index: 2; background-color: transparent;">
                                    @if (cell == 'X')
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == 'O') 
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Opponent Grid -->
            <div class="col-md-6">
                <h3>Opponent Grid</h3>
                <div class="battleship-grid">
                    @for (int r = 0; r < GameClient.CurrentGame.OpponentGrid.Length; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < GameClient.CurrentGame.OpponentGrid[r].Length; c++)
                            {
                                int row = r;
                                int col = c;
                                var cell = GameClient.CurrentGame.OpponentGrid[r][c];
                                <div class="grid-cell @(cell == null ? "clickable" : "")" 
                                     @onclick="() => Attack(row, col)">
                                    @if (cell == true)
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == false)
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- History Section -->
        @if (GameClient.CurrentGame.History.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <h3>Move History</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Turn</th>
                                    <th>Player Move</th>
                                    <th>Result</th>
                                    <th>AI Move</th>
                                    <th>AI Result</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var move in ((IEnumerable<MoveHistory>)GameClient.CurrentGame.History).Reverse())
                            {
                                <tr @onclick="() => UndoToTurn(move.Turn - 1)" style="cursor:pointer;">
                                    <td>@move.Turn</td>
                                    <td>@move.PlayerMove</td>
                                    <td>@move.PlayerResult</td>
                                    <td>@move.AiMove</td>
                                    <td>@move.AiResult</td>
                                </tr>
                            }
                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .battleship-grid {
        display: flex;
        flex-direction: column;
        border: 2px solid #0a2fa8;
        width: fit-content;
        position: relative; 
        background-color: #78a7f5;
        line-height: 0; 
    }

    .grid-row {
        display: flex;
        padding: 0;
        margin: 0;
    }

    .grid-cell {
        width: 35px;
        height: 35px;
        
        box-sizing: border-box; 
        border: 1px solid rgba(17, 27, 120, 0.3); 
        
        display: flex;
        align-items: center;
        justify-content: center;
        
        font-weight: bold;
        font-size: 1.2em;
        padding: 0;
        margin: 0;
        background-color: #78a7f5;
    }
    
    .grid-cell img {
        width: 100%;
        height: 100%;
        object-fit: contain; 
        display: block;
    }
</style>

@code {
    private DifficultyLevel _selectedDifficulty = DifficultyLevel.Medium;
    private int _selectGridSize = 10;

    private async Task StartGame(bool useGrpc)
    {
        await GameClient.StartGameAsync(useGrpc, _selectedDifficulty, _selectGridSize );
        
    }

    private async Task Attack(int row, int col)
    {
        if (GameClient.CurrentGame?.IsGameOver == true) return;
        
        // Prevent attacking already targeted cells
        if (GameClient.CurrentGame?.OpponentGrid[row][col] != null) return;

        await GameClient.AttackAsync(row, col);
    }

    private async Task Undo()
    {
        await GameClient.UndoAsync();
    }
    
    private async Task UndoToTurn(int turn)
    {
        await GameClient.UndoToTurnAsync(turn);
    }

}
