@page "/"
@using BattleShip.App.Services
@using BattleShip.Models
@using BattleShip.App.Components
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration
@inject GameClient GameClient
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@implements IAsyncDisposable

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

<div class="mb-3 control-panel">
    @if (CurrentGame == null)
    {
        <div class="d-flex align-items-center flex-wrap gap-2">
            <label class="form-label fw-bold">Difficulty:</label>
            <select class="form-select w-auto" @bind="_selectedDifficulty">
                <option value="@DifficultyLevel.Easy">Easy</option>
                <option value="@DifficultyLevel.Medium">Medium</option>
                <option value="@DifficultyLevel.Hard">Hard</option>
            </select>

            <label class="form-label fw-bold ms-2">Grid Size:</label>
            <select class="form-select w-auto" @bind="_selectGridSize">
                <option value="10">10x10</option>
                <option value="12">12x12</option>
                <option value="15">15x15</option>
                <option value="20">20x20</option>
            </select>

            <div class="ms-3 border-start ps-3">
                <button class="btn btn-primary" @onclick="() => StartSinglePlayerGame(false)">New Game (REST)</button>
                <button class="btn btn-secondary ms-1" @onclick="() => StartSinglePlayerGame(true)">New Game (gRPC)</button>
            </div>
        </div>
        <div class="d-flex align-items-center flex-wrap gap-2 mt-3 pt-3 border-top">
            <input class="form-control w-auto" @bind="_playerName" placeholder="Your Name" />
            <input class="form-control w-auto" @bind="_gameId" placeholder="Game ID" />
            <button class="btn btn-info" @onclick="JoinMultiplayerGame">Create/Join Multiplayer Game</button>
        </div>
    }
    
    <span class="ms-3 fw-bold text-info">@_message</span>
</div>

@if (CurrentGame != null)
{
    <div class="container-fluid">
        @if (CurrentGame.State == GameState.Setup)
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                @if (CurrentGame.ShipsPlaced)
                {
                    <span><i class="bi bi-hourglass-split me-2"></i>Waiting for opponent to place their ships...</span>
                }
                else
                {
                    <span><i class="bi bi-info-circle-fill me-2"></i>Place your ships. Drag to move, click to rotate.</span>
                    <button class="btn btn-success btn-sm" @onclick="ConfirmPlacement">Confirm Placement</button>
                }
            </div>
        }

        <div class="row g-4">
            <div class="col-md-6">
                <h3 class="text-primary">Your Grid</h3>
                <GridBoard 
                    PlayerGrid="@CurrentGame.PlayerGrid"
                    Ships="@(CurrentGame.State == GameState.Setup && !CurrentGame.ShipsPlaced ? _setupShips : CurrentGame.Ships)"
                    IsDraggable="@(CurrentGame.State == GameState.Setup && !CurrentGame.ShipsPlaced)"
                    IsInteractive="@false"
                    OnDrop="@(args => OnDrop(args.Row, args.Col))"
                    OnDragStart="@OnDragStart"
                    OnRotate="@RotateShip"
                />
            </div>

            <div class="col-md-6">
                <h3 class="text-danger">Opponent Grid</h3>
                <GridBoard 
                    OpponentGrid="@CurrentGame.OpponentGrid"
                    IsInteractive="@(CurrentGame.State == GameState.Playing && CurrentGame.IsMyTurn)"
                    OnCellClick="@(args => Attack(args.Row, args.Col))"
                />
            </div>
        </div>
    </div>
}

@code {
    private GameStatus? CurrentGame => _isMultiplayerGame ? _multiplayerGameStatus : GameClient.CurrentGame;
    private GameStatus? _multiplayerGameStatus;
    
    // Single Player State
    private DifficultyLevel _selectedDifficulty = DifficultyLevel.Medium;
    private int _selectGridSize = 10;

    // Multiplayer State
    private HubConnection? _hubConnection;
    private string? _gameId;
    private string? _playerName = "Player";
    private bool _isMultiplayerGame = false;
    
    // Shared State
    private string? _message;
    private List<ShipInfo> _setupShips = new();
    private ShipInfo? _draggedShip;

    private async Task StartSinglePlayerGame(bool useGrpc)
    {
        _isMultiplayerGame = false;
        await GameClient.StartGameAsync(useGrpc, _selectedDifficulty, _selectGridSize);
        _message = GameClient.Message;
        if (GameClient.CurrentGame?.State == GameState.Setup)
        {
            _setupShips = GameClient.CurrentGame.Ships.Select(s => new ShipInfo { Letter = s.Letter, Size = s.Size }).ToList();
        }
    }

    private async Task JoinMultiplayerGame()
    {
        if (string.IsNullOrWhiteSpace(_gameId) || string.IsNullOrWhiteSpace(_playerName))
        {
            _message = "Please enter a player name and game ID.";
            return;
        }

        _isMultiplayerGame = true;
        var backendUrl = Configuration["BackendUrl"] ?? "http://localhost:5200";
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri($"{backendUrl}/gamehub"))
            .Build();

        _hubConnection.On<GameStatus>("UpdateGameState", (gameStatus) =>
        {
            _multiplayerGameStatus = gameStatus;
            if (_multiplayerGameStatus.State == GameState.Setup && !_multiplayerGameStatus.ShipsPlaced)
            {
                // Only initialize draggable ships if they haven't been placed yet
                if(!_setupShips.Any())
                {
                    _setupShips = _multiplayerGameStatus.Ships.Select(s => new ShipInfo { Letter = s.Letter, Size = s.Size }).ToList();
                }
            }
            UpdateMessage();
            StateHasChanged();
        });
        
        _hubConnection.On<string>("Error", (errorMessage) =>
        {
            _message = errorMessage;
            StateHasChanged();
        });

        _hubConnection.On("OpponentDisconnected", () => {
            _message = "Your opponent has disconnected. The game is over.";
            if (_multiplayerGameStatus != null)
            {
                _multiplayerGameStatus.IsGameOver = true;
            }
            StateHasChanged();
        });

        try
        {
            await _hubConnection.StartAsync();
            await _hubConnection.SendAsync("CreateOrJoinGame", _gameId, _playerName, _selectGridSize);
        }
        catch (Exception ex)
        {
            _message = $"Error connecting to server: {ex.Message}";
        }
    }

    private async Task ConfirmPlacement()
    {
        if (_hubConnection != null && _isMultiplayerGame)
        {
            await _hubConnection.SendAsync("PlaceShips", _setupShips);
        }
    }

    private async Task Attack(int row, int col)
    {
        if (_hubConnection != null && _isMultiplayerGame)
        {
            await _hubConnection.SendAsync("Attack", row, col);
        }
    }

    private void UpdateMessage()
    {
        if (CurrentGame == null) return;
        if (CurrentGame.IsGameOver)
        {
            _message = $"Game Over! Winner: {CurrentGame.Winner}";
            return;
        }
        switch (CurrentGame.State)
        {
            case GameState.Setup:
                 _message = CurrentGame.ShipsPlaced ? "Waiting for opponent..." : "Place your ships.";
                break;
            case GameState.Playing:
                _message = CurrentGame.IsMyTurn ? "Your turn." : "Opponent's turn.";
                break;
        }
    }

    private void OnDragStart(ShipInfo ship) => _draggedShip = ship;
    private void RotateShip(ShipInfo ship) => ship.IsHorizontal = !ship.IsHorizontal;
    private void OnDrop(int row, int col)
    {
        if (_draggedShip == null) return;
        var limit = _selectGridSize;
        if ((_draggedShip.IsHorizontal && col + _draggedShip.Size > limit) || (!_draggedShip.IsHorizontal && row + _draggedShip.Size > limit)) return;
        _draggedShip.Row = row;
        _draggedShip.Col = col;
        _draggedShip = null;
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
