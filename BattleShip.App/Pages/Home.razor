@page "/"
@using BattleShip.App.Services
@inject GameClient GameClient

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="() => StartGame(false)">Start New Game (REST)</button>
    <button class="btn btn-secondary ms-2" @onclick="() => StartGame(true)">Start New Game (gRPC)</button>
    @if (GameClient.CurrentGame != null && !GameClient.CurrentGame.IsGameOver)
    {
        <button class="btn btn-warning ms-2" @onclick="Undo">Undo Last Move</button>
    }
    <span class="ms-3 fw-bold">@GameClient.Message</span>
</div>

@if (GameClient.CurrentGame != null)
{
    <div class="container">
        <div class="row">
            <!-- Player Grid -->
            <div class="col-md-6">
                <h3>Your Grid</h3>
                <div class="battleship-grid">
                    @for (int r = 0; r < 10; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < 10; c++)
                            {
                                var cell = GameClient.CurrentGame.PlayerGrid[r][c];
                                <div class="grid-cell">
                                    @if (cell == 'X')
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == 'O') 
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                    else if (cell != '\0')
                                    {
                                        @cell
                                    }
                                
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Opponent Grid -->
            <div class="col-md-6">
                <h3>Opponent Grid</h3>
                <div class="battleship-grid">
                    @for (int r = 0; r < 10; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < 10; c++)
                            {
                                int row = r;
                                int col = c;
                                var cell = GameClient.CurrentGame.OpponentGrid[r][c];
                                <div class="grid-cell @(cell == null ? "clickable" : "")" 
                                     @onclick="() => Attack(row, col)">
                                    @if (cell == true)
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == false)
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- History Section -->
        @if (GameClient.CurrentGame.History.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <h3>Move History</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark" style="position: sticky; top: 0;">
                                <tr>
                                    <th>Turn</th>
                                    <th>Player Move</th>
                                    <th>Result</th>
                                    <th>AI Move</th>
                                    <th>AI Result</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var move in ((IEnumerable<Models.MoveHistory>)GameClient.CurrentGame.History).Reverse())
                            {
                                <tr @onclick="() => UndoToTurn(move.Turn - 1)" style="cursor:pointer;">
                                    <td>@move.Turn</td>
                                    <td>@move.PlayerMove</td>
                                    <td>@move.PlayerResult</td>
                                    <td>@move.AiMove</td>
                                    <td>@move.AiResult</td>
                                </tr>
                            }
                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}

<style>
    .battleship-grid {
        display: flex;
        flex-direction: column;
        border: 2px solid #333;
        width: fit-content;
    }

    .grid-row {
        display: flex;
    }

    .grid-cell {
        width: 35px;
        height: 35px;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
        background-color: #f0f8ff; /* AliceBlue for water */
    }
    
    .grid-cell img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

</style>

@code {
    private async Task StartGame(bool useGrpc)
    {
        await GameClient.StartGameAsync(useGrpc);
    }

    private async Task Attack(int row, int col)
    {
        if (GameClient.CurrentGame?.IsGameOver == true) return;
        
        // Prevent attacking already targeted cells
        if (GameClient.CurrentGame?.OpponentGrid[row][col] != null) return;

        await GameClient.AttackAsync(row, col);
    }

    private async Task Undo()
    {
        await GameClient.UndoAsync();
    }
    
    private async Task UndoToTurn(int turn)
    {
        await GameClient.UndoToTurnAsync(turn);
    }

}
