@page "/"
@using BattleShip.App.Services
@inject GameClient GameClient

<PageTitle>BattleShip</PageTitle>

<h1>BattleShip</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="StartGame">Start New Game</button>
    <span class="ms-3 fw-bold">@GameClient.Message</span>
</div>

@if (GameClient.CurrentGame != null)
{
    <div class="container">
        <div class="row">
            <!-- Player Grid -->
            <div class="col-md-6">
                <h3>Your Grid</h3>
                <div class="battleship-grid">
                    @for (int r = 0; r < 10; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < 10; c++)
                            {
                                var cell = GameClient.CurrentGame.PlayerGrid[r][c];
                                <div class="grid-cell">
                                    @if (cell == 'X')
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == 'O') 
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                    else if (cell != '\0')
                                    {
                                        @cell
                                    }
                                
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Opponent Grid -->
            <div class="col-md-6">
                <h3>Opponent Grid</h3>
                <div class="battleship-grid">
                    @for (int r = 0; r < 10; r++)
                    {
                        <div class="grid-row">
                            @for (int c = 0; c < 10; c++)
                            {
                                int row = r;
                                int col = c;
                                var cell = GameClient.CurrentGame.OpponentGrid[r][c];
                                <div class="grid-cell @(cell == null ? "clickable" : "")" 
                                     @onclick="() => Attack(row, col)">
                                    @if (cell == true)
                                    {
                                        <img src="/images/hit.png" alt="Hit" />
                                    }
                                    else if (cell == false)
                                    {
                                        <img src="/images/miss.png" alt="Miss" />
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    .battleship-grid {
        display: flex;
        flex-direction: column;
        border: 2px solid #333;
        width: fit-content;
    }

    .grid-row {
        display: flex;
    }

    .grid-cell {
        width: 35px;
        height: 35px;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2em;
        background-color: #f0f8ff; /* AliceBlue for water */
    }
    
    .grid-cell img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

</style>

@code {
    private async Task StartGame()
    {
        await GameClient.StartGameAsync();
    }

    private async Task Attack(int row, int col)
    {
        if (GameClient.CurrentGame?.IsGameOver == true) return;
        
        // Prevent attacking already targeted cells
        if (GameClient.CurrentGame?.OpponentGrid[row][col] != null) return;

        await GameClient.AttackAsync(row, col);
    }
}
