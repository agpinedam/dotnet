@page "/multiplayer"
@using BattleShip.App.Services
@using BattleShip.Models
@using BattleShip.App.Components
@inject MultiplayerGameClient MultiplayerClient
@implements IDisposable

<PageTitle>BattleShip - Multiplayer</PageTitle>

<h1>BattleShip - Multiplayer</h1>

<div class="mb-3 control-panel">
    @if (MultiplayerClient.CurrentGame == null)
    {
        <div class="d-flex align-items-center flex-wrap gap-2">
            <label class="form-label fw-bold">Grid Size:</label>
            <select class="form-select w-auto" @bind="_selectGridSize">
                <option value="10">10x10</option>
                <option value="12">12x12</option>
                <option value="15">15x15</option>
                <option value="20">20x20</option>
            </select>
            <input class="form-control w-auto" @bind="_playerName" placeholder="Your Name" />
            <input class="form-control w-auto" @bind="_gameId" placeholder="Game ID" />
            <button class="btn btn-info" @onclick="JoinMultiplayerGame">Create/Join Multiplayer Game</button>
        </div>
    }
    else
    {
        <div class="d-flex align-items-center flex-wrap gap-2">
            <button class="btn btn-danger" @onclick="LeaveGame">Leave Game</button>
            <span class="ms-3 fw-bold text-info">@MultiplayerClient.Message</span>
        </div>
    }
</div>

@if (MultiplayerClient.CurrentGame != null)
{
    <div class="container-fluid">
        @if (MultiplayerClient.CurrentGame.State == GameState.Setup)
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                @if (MultiplayerClient.CurrentGame.ShipsPlaced)
                {
                    <span><i class="bi bi-hourglass-split me-2"></i>Waiting for opponent to place their ships...</span>
                }
                else
                {
                    <span><i class="bi bi-info-circle-fill me-2"></i>Place your ships. Drag to move, click to rotate.</span>
                    <button class="btn btn-success btn-sm" @onclick="ConfirmPlacement">Confirm Placement</button>
                }
            </div>
        }

        <div class="row g-4">
            <div class="col-md-6">
                <h3 class="text-primary">Your Grid</h3>
                <GridBoard 
                    PlayerGrid="@MultiplayerClient.CurrentGame.PlayerGrid"
                    Ships="@(MultiplayerClient.CurrentGame.State == GameState.Setup && !MultiplayerClient.CurrentGame.ShipsPlaced ? _setupShips : MultiplayerClient.CurrentGame.Ships)"
                    IsDraggable="@(MultiplayerClient.CurrentGame.State == GameState.Setup && !MultiplayerClient.CurrentGame.ShipsPlaced)"
                    IsInteractive="@false"
                    OnDrop="@(args => OnDrop(args.Row, args.Col))"
                    OnDragStart="@OnDragStart"
                    OnRotate="@RotateShip"
                />
            </div>

            <div class="col-md-6">
                <h3 class="text-danger">Opponent Grid</h3>
                <GridBoard 
                    OpponentGrid="@MultiplayerClient.CurrentGame.OpponentGrid"
                    IsInteractive="@(MultiplayerClient.CurrentGame.State == GameState.Playing && MultiplayerClient.CurrentGame.IsMyTurn)"
                    OnCellClick="@(args => Attack(args.Row, args.Col))"
                />
            </div>
        </div>

        @if (MultiplayerClient.CurrentGame.History.Any())
        {
            <div class="row mt-5">
                <div class="col-12">
                    <h3>Battle Log</h3>
                    <div class="history-container shadow-sm">
                        <table class="table table-hover table-bordered mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Turn</th>
                                    <th>Move</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var move in ((IEnumerable<MoveHistory>)MultiplayerClient.CurrentGame.History).Reverse())
                            {
                                <tr>
                                    <td>@move.Turn</td>
                                    <td>@move.PlayerMove</td>
                                    <td>@GetResultBadge(move.PlayerResult)</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private int _selectGridSize = 10;
    private string? _gameId;
    private string? _playerName = "Player";
    
    private List<ShipInfo> _setupShips = new();
    private ShipInfo? _draggedShip;

    protected override void OnInitialized()
    {
        MultiplayerClient.OnChange += StateHasChanged;
    }

    private async Task JoinMultiplayerGame()
    {
        if (string.IsNullOrWhiteSpace(_gameId) || string.IsNullOrWhiteSpace(_playerName)) return;
        await MultiplayerClient.JoinGameAsync(_gameId, _playerName, _selectGridSize);
        if (MultiplayerClient.CurrentGame?.State == GameState.Setup)
        {
            PlaceShipsRandomly();
        }
    }

    private void PlaceShipsRandomly()
    {
        if (MultiplayerClient.CurrentGame == null) return;
        var random = new System.Random();
        var gridSize = _selectGridSize;
        var placedShips = new List<ShipInfo>();

        foreach (var shipTemplate in MultiplayerClient.CurrentGame.Ships)
        {
            bool placed = false;
            while (!placed)
            {
                var ship = new ShipInfo 
                { 
                    Letter = shipTemplate.Letter, 
                    Size = shipTemplate.Size,
                    IsHorizontal = random.Next(2) == 0,
                    Row = random.Next(gridSize),
                    Col = random.Next(gridSize)
                };

                if (IsValidPlacement(ship, placedShips, gridSize))
                {
                    placedShips.Add(ship);
                    placed = true;
                }
            }
        }
        _setupShips = placedShips;
    }

    private bool IsValidPlacement(ShipInfo newShip, List<ShipInfo> existingShips, int gridSize)
    {
        if (newShip.IsHorizontal)
        {
            if (newShip.Col + newShip.Size > gridSize) return false;
        }
        else
        {
            if (newShip.Row + newShip.Size > gridSize) return false;
        }

        foreach (var existing in existingShips)
        {
            if (ShipsOverlap(newShip, existing)) return false;
        }

        return true;
    }

    private bool ShipsOverlap(ShipInfo s1, ShipInfo s2)
    {
        var s1Coords = GetShipCoordinates(s1);
        var s2Coords = GetShipCoordinates(s2);
        return s1Coords.Intersect(s2Coords).Any();
    }

    private List<(int r, int c)> GetShipCoordinates(ShipInfo s)
    {
        var coords = new List<(int r, int c)>();
        for (int i = 0; i < s.Size; i++)
        {
            if (s.IsHorizontal) coords.Add((s.Row, s.Col + i));
            else coords.Add((s.Row + i, s.Col));
        }
        return coords;
    }

    private async Task LeaveGame()
    {
        await MultiplayerClient.LeaveGameAsync();
    }

    private async Task ConfirmPlacement()
    {
        await MultiplayerClient.ConfirmPlacementAsync(_setupShips);
    }

    private async Task Attack(int row, int col)
    {
        if (MultiplayerClient.CurrentGame?.OpponentGrid != null && MultiplayerClient.CurrentGame.OpponentGrid[row][col].HasValue)
        {
            return;
        }
        await MultiplayerClient.AttackAsync(row, col);
    }

    private RenderFragment GetResultBadge(string result)
    {
        var color = result.Contains("Hit") ? "text-danger fw-bold" : "text-muted";
        return @<span class="@color">@result</span>;
    }

    private void OnDragStart(ShipInfo ship) => _draggedShip = ship;

    private void RotateShip(ShipInfo ship)
    {
        var tempShip = new ShipInfo 
        { 
            Letter = ship.Letter, 
            Size = ship.Size, 
            Row = ship.Row, 
            Col = ship.Col, 
            IsHorizontal = !ship.IsHorizontal 
        };

        var otherShips = _setupShips.Where(s => s != ship).ToList();
        if (IsValidPlacement(tempShip, otherShips, _selectGridSize))
        {
            ship.IsHorizontal = !ship.IsHorizontal;
        }
    }

    private void OnDrop(int row, int col)
    {
        if (_draggedShip == null) return;
        
        var tempShip = new ShipInfo 
        { 
            Letter = _draggedShip.Letter, 
            Size = _draggedShip.Size, 
            Row = row, 
            Col = col, 
            IsHorizontal = _draggedShip.IsHorizontal 
        };

        var otherShips = _setupShips.Where(s => s != _draggedShip).ToList();

        if (IsValidPlacement(tempShip, otherShips, _selectGridSize))
        {
            _draggedShip.Row = row;
            _draggedShip.Col = col;
        }
        _draggedShip = null;
    }

    public void Dispose()
    {
        MultiplayerClient.OnChange -= StateHasChanged;
    }
}
