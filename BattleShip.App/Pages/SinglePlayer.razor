@page "/singleplayer"
@using BattleShip.App.Services
@using BattleShip.Models
@using BattleShip.App.Components
@inject GameClient GameClient
@inject ShipPlacementService ShipService

<PageTitle>BattleShip - Single Player</PageTitle>

<h1>BattleShip - Single Player</h1>

<div class="mb-3 control-panel">
    @if (GameClient.CurrentGame == null)
    {
        <div class="d-flex align-items-center flex-wrap gap-2">
            <label class="form-label fw-bold">Difficulty:</label>
            <select class="form-select w-auto" @bind="_selectedDifficulty">
                <option value="@DifficultyLevel.Easy">Easy</option>
                <option value="@DifficultyLevel.Medium">Medium</option>
                <option value="@DifficultyLevel.Hard">Hard</option>
            </select>

            <label class="form-label fw-bold ms-2">Grid Size:</label>
            <select class="form-select w-auto" @bind="_selectGridSize">
                <option value="10">10x10</option>
                <option value="12">12x12</option>
                <option value="15">15x15</option>
                <option value="20">20x20</option>
            </select>

            <div class="ms-3 border-start ps-3">
                <button class="btn btn-primary" @onclick="() => StartSinglePlayerGame(false)">New Game (REST)</button>
                <button class="btn btn-secondary ms-1" @onclick="() => StartSinglePlayerGame(true)">New Game (gRPC)</button>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex align-items-center flex-wrap gap-2">
            <button class="btn btn-danger" @onclick="ResetGame">New Game</button>
            <button class="btn btn-warning" @onclick="UndoAsync">Undo Last Move</button>
            <span class="ms-3 fw-bold text-info">@GameClient.Message</span>
        </div>
    }
</div>

@if (GameClient.CurrentGame != null)
{
    <div class="container-fluid game-container">
        <div class="game-boards">
            @if (GameClient.CurrentGame.State == GameState.Setup)
            {
                <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                    <span><i class="bi bi-info-circle-fill me-2"></i>Place your ships. Drag to move, click to rotate.</span>
                    <button class="btn btn-success btn-sm" @onclick="ConfirmPlacement">Confirm Placement</button>
                </div>
            }

            <div class="d-flex flex-wrap gap-4 flex-grow-1 justify-content-center" style="min-height: 0; overflow-y: auto;">
                <div class="d-flex flex-column align-items-center" style="flex: 1 1 auto;">
                    <h3 class="text-primary flex-shrink-0">Your Grid</h3>
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center w-100" style="min-height: 0;">
                        <GridBoard 
                            PlayerGrid="@GameClient.CurrentGame.PlayerGrid"
                            Ships="@(GameClient.CurrentGame.State == GameState.Setup ? _setupShips : GameClient.CurrentGame.Ships)"
                            IsDraggable="@(GameClient.CurrentGame.State == GameState.Setup)"
                            IsInteractive="@false"
                            OnDrop="@(args => OnDrop(args.Row, args.Col))"
                            OnDragStart="@OnDragStart"
                            OnRotate="@RotateShip"
                        />
                    </div>
                </div>

                <div class="d-flex flex-column align-items-center" style="flex: 1 1 auto;">
                    <h3 class="text-danger flex-shrink-0">Opponent Grid</h3>
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center w-100" style="min-height: 0;">
                        <GridBoard 
                            OpponentGrid="@GameClient.CurrentGame.OpponentGrid"
                            IsInteractive="@(GameClient.CurrentGame.State == GameState.Playing)"
                            OnCellClick="@(args => Attack(args.Row, args.Col))"
                        />
                    </div>
                </div>
            </div>
        </div>

        <div class="game-history">
            @if (GameClient.CurrentGame.History.Any())
            {
                <h5 class="sticky-top bg-light py-2 border-bottom">Battle Log</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Turn</th>
                                <th>Your Move</th>
                                <th>Result</th>
                                <th>Enemy Move</th>
                                <th>Enemy Result</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var move in ((IEnumerable<MoveHistory>)GameClient.CurrentGame.History).Reverse())
                        {
                            <tr @onclick="() => UndoToTurnAsync(move.Turn - 1)" 
                                class="cursor-pointer" 
                                title="Click to time travel to this turn">
                                <td>@move.Turn</td>
                                <td>@move.PlayerMove</td>
                                <td>@GetResultBadge(move.PlayerResult)</td>
                                <td>@move.AiMove</td>
                                <td>@GetResultBadge(move.AiResult)</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted mt-4">
                    <i class="bi bi-clock-history fs-2"></i>
                    <p>Battle history will appear here.</p>
                </div>
            }
        </div>
    </div>
}

<style>
    .game-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px); /* Adjust based on header/controls height */
        overflow: hidden;
    }

    .game-boards {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding-bottom: 1rem;
        min-height: 0; /* Important for flex scrolling */
    }

    .game-history {
        height: 25%; /* Fixed 1/4 height */
        flex-shrink: 0;
        border-top: 4px solid #dee2e6;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 0.5rem 1rem;
    }
</style>

@code {
    private DifficultyLevel _selectedDifficulty = DifficultyLevel.Medium;
    private int _selectGridSize = 10;
    
    private List<ShipInfo> _setupShips = new();
    private ShipInfo? _draggedShip;

    private void ResetGame()
    {
        GameClient.ResetGame();
    }

    private async Task StartSinglePlayerGame(bool useGrpc)
    {
        await GameClient.StartGameAsync(useGrpc, _selectedDifficulty, _selectGridSize);
        if (GameClient.CurrentGame?.State == GameState.Setup)
        {
            PlaceShipsRandomly();
        }
    }

    private void PlaceShipsRandomly()
    {
        if (GameClient.CurrentGame == null) return;
        _setupShips = ShipService.PlaceShipsRandomly(GameClient.CurrentGame.Ships, _selectGridSize);
    }

    private async Task ConfirmPlacement()
    {
        await GameClient.PlaceShipsAsync(_setupShips);
    }

    private async Task Attack(int row, int col)
    {
        if (GameClient.CurrentGame?.OpponentGrid != null && GameClient.CurrentGame.OpponentGrid[row][col].HasValue)
        {
            return;
        }
        await GameClient.AttackAsync(row, col);
    }

    private async Task UndoAsync()
    {
        await GameClient.UndoAsync();
    }

    private async Task UndoToTurnAsync(int turn)
    {
        await GameClient.UndoToTurnAsync(turn);
    }

    private RenderFragment GetResultBadge(string result)
    {
        var color = result.Contains("Hit") ? "text-danger fw-bold" : "text-muted";
        return @<span class="@color">@result</span>;
    }

    private void OnDragStart(ShipInfo ship)
    {
        if (GameClient.CurrentGame?.State != GameState.Setup) return;
        _draggedShip = ship;
    }

    private void RotateShip(ShipInfo ship)
    {
        if (GameClient.CurrentGame?.State != GameState.Setup) return;
        
        var tempShip = new ShipInfo 
        { 
            Letter = ship.Letter, 
            Size = ship.Size, 
            Row = ship.Row, 
            Col = ship.Col, 
            IsHorizontal = !ship.IsHorizontal 
        };

        var otherShips = _setupShips.Where(s => s != ship).ToList();
        if (ShipService.IsValidPlacement(tempShip, otherShips, _selectGridSize))
        {
            ship.IsHorizontal = !ship.IsHorizontal;
        }
    }

    private void OnDrop(int row, int col)
    {
        if (GameClient.CurrentGame?.State != GameState.Setup) return;
        if (_draggedShip == null) return;
        
        var tempShip = new ShipInfo 
        { 
            Letter = _draggedShip.Letter, 
            Size = _draggedShip.Size, 
            Row = row, 
            Col = col, 
            IsHorizontal = _draggedShip.IsHorizontal 
        };

        var otherShips = _setupShips.Where(s => s != _draggedShip).ToList();

        if (ShipService.IsValidPlacement(tempShip, otherShips, _selectGridSize))
        {
            _draggedShip.Row = row;
            _draggedShip.Col = col;
        }
        _draggedShip = null;
    }
}
